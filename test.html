<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<div id="my_dataviz"></div>

<div id="controls">
    <label for="stateSelect">Select State:</label>
    <select id="stateSelect"></select>
    <label for="yearSlider">Year:</label>
    <input type="range" id="yearSlider" min="2013" max="2023" step="1" value="2023">
    <span id="yearLabel">2023</span>
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>
</div>

<script>
// ------------------- SVG setup -------------------
const margin = {top: 50, right: 30, bottom: 80, left: 100},
      width = 700 - margin.left - margin.right,
      height = 450 - margin.top - margin.bottom;

const svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// ------------------- Global variables -------------------
let dataGlobal;
let playInterval;

// ------------------- Load CSV -------------------
d3.csv("Behavioral_Risk_Factor_Surveillance_System.csv").then(data => {
    // Convert numbers
    data.forEach(d => {
        d.Sample_Size = +d.Sample_Size.replace(/,/g,"");
        d.Data_value = +d.Data_value;
        d.Year = +d.Year;
    });
    dataGlobal = data;

    // ------------------- Dropdown states -------------------
    const states = [...new Set(data.map(d => d.Locationdesc))];
    const stateSelect = d3.select("#stateSelect");
    states.forEach(s => stateSelect.append("option").text(s).attr("value", s));

    // ------------------- Unique ages & races -------------------
    const ages = [...new Set(data.filter(d => d.Topic==="Age").map(d=>d.Response))];
    const races = [...new Set(data.filter(d => d.Break_Out_Category==="Race/Ethnicity").map(d=>d.Break_Out))];

    // ------------------- Scales -------------------
    const x = d3.scaleBand().domain(races).range([0,width]).padding(0.05);
    const y = d3.scaleBand().domain(ages).range([0,height]).padding(0.05);
    const colorScale = d3.scaleSequential(d3.interpolateBlues);

    // ------------------- Axes -------------------
    svg.append("g").attr("class","xAxis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text").attr("transform","rotate(-45)").style("text-anchor","end");

    svg.append("g").attr("class","yAxis")
        .call(d3.axisLeft(y));

    // ------------------- Update function -------------------
    function updateHeatmap(state, year) {
        const filtered = dataGlobal.filter(d =>
            d.Topic==="Age" &&
            d.Break_Out_Category==="Race/Ethnicity" &&
            d.Locationdesc===state &&
            d.Year===+year
        );

        colorScale.domain([0, d3.max(filtered,d=>d.Data_value)]);

        svg.selectAll("rect")
            .data(filtered, d => d.Response + ":" + d.Break_Out)
            .join("rect")
            .attr("x", d => x(d.Break_Out))
            .attr("y", d => y(d.Response))
            .attr("width", x.bandwidth())
            .attr("height", y.bandwidth())
            .style("fill", d => colorScale(d.Data_value))
            .append("title")
            .text(d => `Race: ${d.Break_Out}\nAge: ${d.Response}\nValue: ${d.Data_value}\nSample: ${d.Sample_Size}`);
    }

    // ------------------- Initial draw -------------------
    const initialState = states[0];
    const initialYear = +d3.select("#yearSlider").property("value");
    updateHeatmap(initialState, initialYear);

    // ------------------- Event listeners -------------------
    d3.select("#stateSelect").on("change", function(){
        updateHeatmap(this.value, +d3.select("#yearSlider").property("value"));
    });

    d3.select("#yearSlider").on("input", function(){
        d3.select("#yearLabel").text(this.value);
        updateHeatmap(d3.select("#stateSelect").property("value"), +this.value);
    });

    d3.select("#playBtn").on("click", function(){
        if(playInterval) clearInterval(playInterval);
        let year = +d3.select("#yearSlider").property("value");
        playInterval = setInterval(()=>{
            year++;
            if(year > +d3.select("#yearSlider").attr("max")) year = +d3.select("#yearSlider").attr("min");
            d3.select("#yearSlider").property("value",year);
            d3.select("#yearLabel").text(year);
            updateHeatmap(d3.select("#stateSelect").property("value"), year);
        }, 1000);
    });

    d3.select("#pauseBtn").on("click", function(){
        if(playInterval) clearInterval(playInterval);
    });

}).catch(err=>console.error(err));
</script>
